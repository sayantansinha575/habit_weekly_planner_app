datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String  @id @default(uuid())
  email           String  @unique
  passwordHash    String
  whatsappNumber  String?
  username        String?
  profilePhotoUrl String?

  // Stats
  dailyStreak       Int      @default(0)
  weeklyStreak      Int      @default(0)
  streakFreezeCount Int      @default(0)
  lastActiveAt      DateTime @default(now())

  // Subscription
  subscriptionStatus  SubscriptionStatus @default(FREE)
  trialStartDate      DateTime?
  subscriptionEndDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasks             Task[]
  dailySteps        DailyStep[]
  notificationPrefs NotificationPreference?
  userAchievements  UserAchievement[]
  calAiProfile      CalAiProfile?
  calAiMeals        CalAiMeal[]
}

model Task {
  id                    String   @id @default(uuid())
  title                 String
  description           String?
  isCompleted           Boolean  @default(false)
  isAutoRolled          Boolean  @default(false)
  rolledCount           Int      @default(0)
  scheduledDate         DateTime
  scheduledTime         String? // e.g. "14:30"
  isNotificationEnabled Boolean  @default(true)
  userId                String
  user                  User     @relation(fields: [userId], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Template {
  id          String   @id @default(uuid())
  title       String
  icon        String
  description String
  tasks       Json // Store default tasks as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// New Models

enum SubscriptionStatus {
  FREE
  TRIAL
  PREMIUM
  EXPIRED
}

model DailyStep {
  id     String   @id @default(uuid())
  userId String
  user   User     @relation(fields: [userId], references: [id])
  date   DateTime @db.Date // Store as date only
  count  Int      @default(0)
  goal   Int      @default(10000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
}

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  habitReminders   Boolean @default(true)
  motivationAlerts Boolean @default(true)
  stepMilestones   Boolean @default(true)
  weatherNudges    Boolean @default(true)

  updatedAt DateTime @updatedAt
}

model Achievement {
  id          String  @id @default(uuid())
  title       String
  description String
  icon        String
  condition   String? // e.g. "7_day_streak"

  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  achievementId String
  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())

  @@unique([userId, achievementId])
}

model Quote {
  id        String    @id @default(uuid())
  text      String
  author    String?
  category  String?
  shownDate DateTime? @db.Date
}

model CalAiProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  goalWeight    Float
  currentWeight Float
  height        String
  dateOfBirth   DateTime
  gender        String
  dailyStepGoal Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  meals CalAiMeal[]
}

model CalAiMeal {
  id          String   @id @default(uuid())
  userId      String
  profileId   String?
  calories    Int
  protein     Float
  carbs       Float
  fats        Float
  description String
  date        DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id])
  profile CalAiProfile? @relation(fields: [profileId], references: [id])
}
